---
- name: FILESERVER - CRÉATION DU DATASET ZFS parent
  community.general.zfs:
    name: "{{ zfs.dataset.fileserver.parent.name }}"
    state: present
    extra_zfs_properties:
      mountpoint: "{{ zfs.dataset.fileserver.parent.extra.mountpoint }}"
      compression: "{{ zfs.dataset.fileserver.parent.extra.compression }}"
      atime: "{{ zfs.dataset.fileserver.parent.extra.atime }}"
      xattr: "{{ zfs.dataset.fileserver.parent.extra.xattr }}"
      recordsize: "{{ zfs.dataset.fileserver.parent.extra.recordsize }}"
      quota: "{{ zfs.dataset.fileserver.parent.extra.quota }}"
  when: zfs.dataset.fileserver.parent.create == true

- name: FILESERVER - CRÉATION DU DATASET ZFS enfant - POINT DE MONTAGE HOST<->LXC
  community.general.zfs:
    name: "{{ zfs.dataset.fileserver.child.name }}"
    state: present
    extra_zfs_properties:
      mountpoint: "{{ zfs.dataset.fileserver.child.mountpoint.host }}"
  when: zfs.dataset.fileserver.child.create == true

- name: FILESERVER - CONFIGURATION DU POINT DE MONTAGE HOST<->LXC
  command: pct set 142 -mp0 "{{ zfs.dataset.fileserver.child.mountpoint.host }}",mp="{{ zfs.dataset.fileserver.child.mountpoint.lxc }}"
  when: zfs.dataset.fileserver.child.create
  
- name: FILESERVER - CHANGEMENT DES DROITS UTILISATEUR SUR LE POINT DE MONTAGE
  file:
    dest: "{{ zfs.dataset.fileserver.child.mountpoint.host }}"
    owner: 101000
    group: 101000
    mode: 0777
    recurse: true

- name: FILESERVER - REDÉMARRAGE DU CONTENEUR LXC
  community.general.proxmox:
    node: morpheus
    api_host: 192.168.10.5
    api_user: root@pam
    api_password: "{{ secret.proxmox.morpheus.api.password }}"
    api_token_id: "{{ secret.proxmox.morpheus.api.token_id }}"
    api_token_secret: "{{ secret.proxmox.morpheus.api.token_secret }}"
    vmid: 142
    state: "restarted"
    timeout: 90
